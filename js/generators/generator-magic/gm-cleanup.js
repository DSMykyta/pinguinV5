// js/generators/generator-magic/gm-cleanup.js

/**
 * ╔══════════════════════════════════════════════════════════════════════════╗
 * ║                    MAGIC LEGO - CLEANUP PLUGIN                           ║
 * ╠══════════════════════════════════════════════════════════════════════════╣
 * ║  🔌 ПЛАГІН — Очистка тексту від сміття                                   ║
 * ║                                                                          ║
 * ║  ФУНКЦІЇ:                                                                ║
 * ║  - cleanText(text) — Очистити текст                                      ║
 * ║  - normalizeDecimals(text) — Нормалізувати десяткові                     ║
 * ║  - stripHtml(text) — Видалити HTML теги                                  ║
 * ╚══════════════════════════════════════════════════════════════════════════╝
 */

import { markPluginLoaded } from './gm-state.js';

export const PLUGIN_NAME = 'gm-cleanup';

// ============================================================================
// ІНІЦІАЛІЗАЦІЯ
// ============================================================================

export function init() {
    markPluginLoaded(PLUGIN_NAME);
}

// ============================================================================
// СИМВОЛИ ДЛЯ ВИДАЛЕННЯ
// ============================================================================

export const CLEANUP_SYMBOLS = /\*\*|[†‡✝×®*•○◊■□▪▫♦◆●▶►▷❖✦✧⬥⬦]/g;

// ============================================================================
// ГОЛОВНА ФУНКЦІЯ
// ============================================================================

/**
 * Очищає текст від сміття
 * @param {string} text - Вхідний текст
 * @returns {string} - Очищений текст
 */
export function cleanText(text) {
    if (!text || typeof text !== 'string') {
        return '';
    }

    return text
        // Видаляємо зайві символи
        .replace(CLEANUP_SYMBOLS, '')
        // Видаляємо відсотки в кінці рядка (включаючи <1%)
        .replace(/\s+[<>]?\s*[\d,.]+%\s*$/gm, '')
        // Двокрапка між назвою і значенням → пробіл
        .replace(/:\s*(?=\d)/g, ' ')
        // Табуляції → пробіли
        .replace(/\t+/g, ' ')
        // Тисячні роздільники (1,000 → 1000)
        .replace(/(\d),(\d{3})/g, '$1$2')
        // Кілька пробілів → один (але НЕ переноси рядків!)
        .replace(/[^\S\n]+/g, ' ');
}

// ============================================================================
// ДОПОМІЖНІ ФУНКЦІЇ
// ============================================================================

/**
 * Нормалізує десяткові роздільники (кома → крапка)
 */
export function normalizeDecimals(text) {
    return text.replace(/(\d),(\d{1,2})(?!\d)/g, '$1.$2');
}

// stripHtml — re-export з text-utils
export { stripHtmlTags as stripHtml } from '../../utils/text-utils.js';
