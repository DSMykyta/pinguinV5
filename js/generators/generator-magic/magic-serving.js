// js/generators/generator-magic/magic-serving.js

/**
 * ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
 * ‚ïë                    MAGIC LEGO - SERVING PLUGIN                           ‚ïë
 * ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
 * ‚ïë  üîå –ü–õ–ê–ì–Ü–ù ‚Äî –†–æ–∑–º—ñ—Ä –ø–æ—Ä—Ü—ñ—ó —Ç–∞ —Å–ª—É–∂–±–æ–≤—ñ —Ä—è–¥–∫–∏                             ‚ïë
 * ‚ïë                                                                          ‚ïë
 * ‚ïë  –§–£–ù–ö–¶–Ü–á:                                                                ‚ïë
 * ‚ïë  - extractServingSize(text) ‚Äî –í–∏—Ç—è–≥–Ω—É—Ç–∏ —Ä–æ–∑–º—ñ—Ä –ø–æ—Ä—Ü—ñ—ó                    ‚ïë
 * ‚ïë  - shouldSkipLine(line) ‚Äî –ß–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ —Ä—è–¥–æ–∫                            ‚ïë
 * ‚ïë  - isServingLine(line) ‚Äî –ß–∏ —Ä—è–¥–æ–∫ —î –ø–æ—Ä—Ü—ñ—î—é                              ‚ïë
 * ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
 */

import { markPluginLoaded } from './magic-state.js';

export const PLUGIN_NAME = 'magic-serving';

// ============================================================================
// –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
// ============================================================================

export function init() {
    markPluginLoaded(PLUGIN_NAME);
}

// ============================================================================
// –ü–ê–¢–ï–†–ù–ò
// ============================================================================

export const IHERB_SKIP_PATTERNS = [
    /^(—Ä–∞–∑–º–µ—Ä –ø–æ—Ä—Ü–∏–∏|—Ä–æ–∑–º—ñ—Ä –ø–æ—Ä—Ü—ñ—ó|serving size)[:\s]/i,
    /^(–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—Ü–∏–π|–∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ—Ä—Ü—ñ–π|servings per)/i,
    /^(–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ –ø–æ—Ä—Ü–∏—é|–∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–∞ –ø–æ—Ä—Ü—ñ—é|amount per)/i,
    /^%\s*(–æ—Ç —Å—É—Ç–æ—á–Ω–æ–π|–≤—ñ–¥ –¥–æ–±–æ–≤–æ—ó|daily value)/i,
    /^\*?\s*(percent daily|—Å—É—Ç–æ—á–Ω|–¥–æ–±–æ–≤)/i,
    /^(daily value|–¥–µ–Ω–Ω–∞ –Ω–æ—Ä–º–∞|—Å—É—Ç–æ—á–Ω–∞—è –Ω–æ—Ä–º–∞)\s+(not established|–Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω|–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)/i,
    /percent daily values? (are |is )?based on/i,
];

// ============================================================================
// –§–£–ù–ö–¶–Ü–á
// ============================================================================

export function extractServingSize(text) {
    if (!text) return '';

    const patterns = [
        /—Ä–∞–∑–º–µ—Ä –ø–æ—Ä—Ü–∏–∏[:\s]+(.+?)(?:\n|$)/i,
        /—Ä–æ–∑–º—ñ—Ä –ø–æ—Ä—Ü—ñ—ó[:\s]+(.+?)(?:\n|$)/i,
        /serving size[:\s]+(.+?)(?:\n|$)/i,
        /–ø–æ—Ä—Ü–∏—è[:\s]+(.+?)(?:\n|$)/i,
        /–ø–æ—Ä—Ü—ñ—è[:\s]+(.+?)(?:\n|$)/i,
    ];

    for (const pattern of patterns) {
        const match = text.match(pattern);
        if (match) {
            return match[1].trim();
        }
    }

    return '';
}

export function shouldSkipLine(line) {
    if (!line) return true;

    const trimmed = line.trim();
    if (!trimmed) return true;

    return IHERB_SKIP_PATTERNS.some(pattern => pattern.test(trimmed));
}

export function isServingLine(line) {
    if (!line) return false;
    return /^(\d+\s*(–≥|g|–º–ª|ml|—Ç–∞–±–ª–µ—Ç–∫|–∫–∞–ø—Å—É–ª|–ø–æ—Ä—Ü|softgel|tablet|capsule))/i.test(line.trim());
}
