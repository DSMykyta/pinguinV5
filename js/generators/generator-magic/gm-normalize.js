// js/generators/generator-magic/magic-normalize.js

/**
 * â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
 * â•‘                    MAGIC LEGO - NORMALIZE PLUGIN                         â•‘
 * â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
 * â•‘  ðŸ”Œ ÐŸÐ›ÐÐ“Ð†Ð â€” ÐÐ¾Ñ€Ð¼Ð°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ Ð½Ð°Ð·Ð² Ð½ÑƒÑ‚Ñ€Ñ–Ñ”Ð½Ñ‚Ñ–Ð²                                â•‘
 * â•‘                                                                          â•‘
 * â•‘  Ð¤Ð£ÐÐšÐ¦Ð†Ð‡:                                                                â•‘
 * â•‘  - normalizeNutrientName(name) â€” ÐÐ¾Ñ€Ð¼Ð°Ð»Ñ–Ð·ÑƒÐ²Ð°Ñ‚Ð¸ Ð½Ð°Ð·Ð²Ñƒ                     â•‘
 * â•‘  - sortNutrients(entries) â€” Ð¡Ð¾Ñ€Ñ‚ÑƒÐ²Ð°Ñ‚Ð¸ Ð·Ð° ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð¸Ð¼ Ð¿Ð¾Ñ€ÑÐ´ÐºÐ¾Ð¼            â•‘
 * â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

import { markPluginLoaded } from './magic-state.js';

export const PLUGIN_NAME = 'magic-normalize';

// ============================================================================
// Ð†ÐÐ†Ð¦Ð†ÐÐ›Ð†Ð—ÐÐ¦Ð†Ð¯
// ============================================================================

export function init() {
    markPluginLoaded(PLUGIN_NAME);
}

// ============================================================================
// ÐœÐÐŸÐ ÐÐžÐ ÐœÐÐ›Ð†Ð—ÐÐ¦Ð†Ð‡
// ============================================================================

const MAIN_NUTRIENTS = [
    [/^(ÐºÐ°Ð»Ð¾Ñ€Ð¸Ð¹Ð½Ð¾ÑÑ‚ÑŒ|ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ñ†ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ|ÐºÐ°Ð»Ð¾Ñ€Ñ–Ñ—|ÐµÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ñ‡Ð½Ð° Ñ†Ñ–Ð½Ð½Ñ–ÑÑ‚ÑŒ|energy|kcal)$/i, 'ÐšÐ°Ð»Ð¾Ñ€Ð¸Ð¸'],
    [/^(Ð²ÑÐµÐ³Ð¾ Ð¶Ð¸Ñ€(Ð¾Ð²|Ð°)?|Ð¾Ð±Ñ‰(ÐµÐµ|Ð¸Ð¹) (ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ðµ )?Ð¶Ð¸Ñ€(Ð¾Ð²|Ð°)?|total fat|Ð¶Ð¸Ñ€Ð¸|Ð·Ð°Ð³Ð°Ð»ÑŒÐ½Ð¸Ð¹ Ð²Ð¼Ñ–ÑÑ‚ Ð¶Ð¸Ñ€Ñƒ)$/i, 'Ð–Ð¸Ñ€Ñ‹'],
    [/^(Ñ…Ð¾Ð»ÐµÑÑ‚ÐµÑ€Ð¸Ð½(Ð°)?|Ñ…Ð¾Ð»ÐµÑÑ‚ÐµÑ€Ð¾Ð»|cholesterol)$/i, 'Ð¥Ð¾Ð»ÐµÑÑ‚ÐµÑ€Ð¸Ð½'],
    [/^(Ð²ÑÐµÐ³Ð¾ ÑƒÐ³Ð»ÐµÐ²Ð¾Ð´(Ð¾Ð²|Ñ‹)?|Ð¾Ð±Ñ‰(ÐµÐµ|Ð¸Ð¹) (ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ |ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ðµ )?ÑƒÐ³Ð»ÐµÐ²Ð¾Ð´(Ð¾Ð²|Ñ‹)?|total carb(ohyd)?r?(ate)?s?|Ð²ÑƒÐ³Ð»ÐµÐ²Ð¾Ð´Ð¸|Ð·Ð°Ð³Ð°Ð»ÑŒÐ½Ð° ÐºÑ–Ð»ÑŒÐºÑ–ÑÑ‚ÑŒ Ð²ÑƒÐ³Ð»ÐµÐ²Ð¾Ð´Ñ–Ð²)$/i, 'Ð£Ð³Ð»ÐµÐ²Ð¾Ð´Ñ‹'],
    [/^(Ð±ÐµÐ»Ð¾Ðº|Ð±ÐµÐ»ÐºÐ¸|Ð±ÐµÐ»ÐºÐ¾Ð²|Ð±Ñ–Ð»Ð¾Ðº|Ð±Ñ–Ð»ÐºÐ°|Ð±Ñ–Ð»ÐºÑ–Ð²|protein)$/i, 'Ð‘ÐµÐ»Ð¾Ðº'],
    [/^(ÑÐ¾Ð»ÑŒ|ÑÐ¾Ð»Ñ–|salt)$/i, 'Ð¡Ð¾Ð»ÑŒ'],
];

const SUBCATEGORIES = [
    // Ð–Ð¸Ñ€Ð¸
    [/(Ð½Ð°ÑÑ‹Ñ‰ÐµÐ½Ð½?(Ñ‹Ðµ|Ñ‹Ñ…)( Ð¶Ð¸Ñ€(Ñ‹|Ð¾Ð²)?)?|saturated( fat)?|Ð½Ð°ÑÐ¸Ñ‡ÐµÐ½Ñ–( Ð¶Ð¸Ñ€Ð¸)?)$/i, 'Ð½Ð°ÑÑ‹Ñ‰ÐµÐ½Ð½Ñ‹Ðµ', 'ÐÐ°ÑÑ‹Ñ‰ÐµÐ½Ð½Ñ‹Ðµ Ð¶Ð¸Ñ€Ñ‹', false],
    [/(Ñ‚Ñ€Ð°Ð½Ñ[- ]?Ð¶Ð¸Ñ€(Ñ‹|Ð¾Ð²)?|trans( fat)?)$/i, 'Ñ‚Ñ€Ð°Ð½Ñ-Ð¶Ð¸Ñ€Ñ‹', 'Ð¢Ñ€Ð°Ð½Ñ-Ð¶Ð¸Ñ€Ñ‹', false],
    [/(Ð½ÐµÐ½Ð°ÑÑ‹Ñ‰ÐµÐ½Ð½?(Ñ‹Ðµ|Ñ‹Ñ…)( Ð¶Ð¸Ñ€(Ñ‹|Ð¾Ð²)?)?|unsaturated|Ð½ÐµÐ½Ð°ÑÐ¸Ñ‡ÐµÐ½Ñ–)$/i, 'Ð½ÐµÐ½Ð°ÑÑ‹Ñ‰ÐµÐ½Ð½Ñ‹Ðµ', 'ÐÐµÐ½Ð°ÑÑ‹Ñ‰ÐµÐ½Ð½Ñ‹Ðµ Ð¶Ð¸Ñ€Ñ‹', false],
    [/(Ð¼Ð¾Ð½Ð¾Ð½ÐµÐ½Ð°ÑÑ‹Ñ‰ÐµÐ½Ð½?(Ñ‹Ðµ|Ñ‹Ñ…)?|monounsaturated)$/i, 'Ð¼Ð¾Ð½Ð¾Ð½ÐµÐ½Ð°ÑÑ‹Ñ‰ÐµÐ½Ð½Ñ‹Ðµ', 'ÐœÐ¾Ð½Ð¾Ð½ÐµÐ½Ð°ÑÑ‹Ñ‰ÐµÐ½Ð½Ñ‹Ðµ Ð¶Ð¸Ñ€Ñ‹', false],
    [/(Ð¿Ð¾Ð»Ð¸Ð½ÐµÐ½Ð°ÑÑ‹Ñ‰ÐµÐ½Ð½?(Ñ‹Ðµ|Ñ‹Ñ…)?|polyunsaturated)$/i, 'Ð¿Ð¾Ð»Ð¸Ð½ÐµÐ½Ð°ÑÑ‹Ñ‰ÐµÐ½Ð½Ñ‹Ðµ', 'ÐŸÐ¾Ð»Ð¸Ð½ÐµÐ½Ð°ÑÑ‹Ñ‰ÐµÐ½Ð½Ñ‹Ðµ Ð¶Ð¸Ñ€Ñ‹', false],
    // Ð’ÑƒÐ³Ð»ÐµÐ²Ð¾Ð´Ð¸
    [/(Ð¿Ð¸Ñ‰ÐµÐ²(Ñ‹Ðµ|Ñ‹Ñ…) Ð²Ð¾Ð»Ð¾ÐºÐ½(Ð°|Ð¾)?|Ð¿Ð¸Ñ‰ÐµÐ²Ñ‹Ñ… Ð²Ð¾Ð»Ð¾ÐºÐ¾Ð½|ÐºÐ»ÐµÑ‚Ñ‡Ð°Ñ‚Ðº(Ð°|Ð¸)|dietary fiber|fibre?|Ñ…Ð°Ñ€Ñ‡Ð¾Ð²Ñ– Ð²Ð¾Ð»Ð¾ÐºÐ½Ð°)$/i, 'Ð¿Ð¸Ñ‰ÐµÐ²Ñ‹Ðµ Ð²Ð¾Ð»Ð¾ÐºÐ½Ð°', 'ÐŸÐ¸Ñ‰ÐµÐ²Ñ‹Ðµ Ð²Ð¾Ð»Ð¾ÐºÐ½Ð°', true],
    [/(Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð½?(Ñ‹Ð¹|Ñ‹Ñ…|Ð¾Ð³Ð¾) ÑÐ°Ñ…Ð°Ñ€(Ð°|Ð¾Ð²)?|added sugars?|includes.*added|Ð´Ð¾Ð´Ð°Ð½Ð¸Ð¹ Ñ†ÑƒÐºÐ¾Ñ€)$/i, 'Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ ÑÐ°Ñ…Ð°Ñ€Ð°', 'Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ ÑÐ°Ñ…Ð°Ñ€', true],
    [/^(Ð²ÑÐµÐ³Ð¾ ÑÐ°Ñ…Ð°Ñ€(Ð¾Ð²|Ð°)?|Ð¾Ð±Ñ‰(ÐµÐµ|Ð¸Ð¹) (ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ðµ )?ÑÐ°Ñ…Ð°Ñ€(Ð¾Ð²|Ð°)?|total sugars?|sugars?)$/i, 'ÑÐ°Ñ…Ð°Ñ€', 'Ð¡Ð°Ñ…Ð°Ñ€', true],
    [/^(ÑÐ°Ñ…Ð°Ñ€(Ð°|Ð¾Ð²)?|Ñ†ÑƒÐºÐ¾Ñ€|Ñ†ÑƒÐºÑ€Ñƒ)$/i, 'ÑÐ°Ñ…Ð°Ñ€', 'Ð¡Ð°Ñ…Ð°Ñ€', false],
];

// ============================================================================
// Ð“ÐžÐ›ÐžÐ’ÐÐ Ð¤Ð£ÐÐšÐ¦Ð†Ð¯
// ============================================================================

export function normalizeNutrientName(name) {
    if (!name) return '';

    const cleaned = name.replace(/:$/, '').trim();

    // ÐžÑÐ½Ð¾Ð²Ð½Ñ– Ð½ÑƒÑ‚Ñ€Ñ–Ñ”Ð½Ñ‚Ð¸
    for (const [regex, normalized] of MAIN_NUTRIENTS) {
        if (regex.test(cleaned)) {
            return normalized;
        }
    }

    // ÐŸÑ–Ð´ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ñ–Ñ—
    const isSubcategory = /^-\s*/.test(cleaned);
    const withoutDash = cleaned.replace(/^-\s*/, '');

    for (const [regex, subName, standaloneName, alwaysSub] of SUBCATEGORIES) {
        if (regex.test(withoutDash)) {
            return (isSubcategory || alwaysSub) ? ' - ' + subName : standaloneName;
        }
    }

    return cleaned;
}

// ============================================================================
// Ð¡ÐžÐ Ð¢Ð£Ð’ÐÐÐÐ¯
// ============================================================================

const NUTRIENT_ORDER = [
    'ÐšÐ°Ð»Ð¾Ñ€Ð¸Ð¸',
    'Ð–Ð¸Ñ€Ñ‹',
    ' - Ð½Ð°ÑÑ‹Ñ‰ÐµÐ½Ð½Ñ‹Ðµ',
    ' - Ñ‚Ñ€Ð°Ð½Ñ-Ð¶Ð¸Ñ€Ñ‹',
    ' - Ð½ÐµÐ½Ð°ÑÑ‹Ñ‰ÐµÐ½Ð½Ñ‹Ðµ',
    ' - Ð¼Ð¾Ð½Ð¾Ð½ÐµÐ½Ð°ÑÑ‹Ñ‰ÐµÐ½Ð½Ñ‹Ðµ',
    ' - Ð¿Ð¾Ð»Ð¸Ð½ÐµÐ½Ð°ÑÑ‹Ñ‰ÐµÐ½Ð½Ñ‹Ðµ',
    'Ð¥Ð¾Ð»ÐµÑÑ‚ÐµÑ€Ð¸Ð½',
    'Ð£Ð³Ð»ÐµÐ²Ð¾Ð´Ñ‹',
    ' - Ð¿Ð¸Ñ‰ÐµÐ²Ñ‹Ðµ Ð²Ð¾Ð»Ð¾ÐºÐ½Ð°',
    ' - ÑÐ°Ñ…Ð°Ñ€',
    ' - Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ ÑÐ°Ñ…Ð°Ñ€Ð°',
    'Ð‘ÐµÐ»Ð¾Ðº',
    'Ð¡Ð¾Ð»ÑŒ',
];

function getNutrientIndex(name) {
    const idx = NUTRIENT_ORDER.indexOf(name);
    return idx !== -1 ? idx : 999;
}

export function sortNutrients(entries) {
    if (!Array.isArray(entries)) return [];

    return [...entries].sort((a, b) => {
        const idxA = getNutrientIndex(a.left);
        const idxB = getNutrientIndex(b.left);
        return idxA - idxB;
    });
}
