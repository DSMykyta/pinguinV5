// js/generators/generator-table/gt-magic-normalize.js

/**
 * ╔══════════════════════════════════════════════════════════════════════════╗
 * ║                    GT-MAGIC-NORMALIZE v1.0                               ║
 * ║              Нормалізація назв нутрієнтів                                ║
 * ╚══════════════════════════════════════════════════════════════════════════╝
 *
 * ПРИЗНАЧЕННЯ:
 * Спрощує назви нутрієнтів до стандартного вигляду:
 * - "Всего углеводов" → "Углеводы"
 * - "Насыщенные жиры" → " - насыщенные"
 * - "Всього вуглеводів" → "Вуглеводи"
 *
 * ЕКСПОРТ:
 * - normalizeNutrientName(name) - нормалізувати назву
 */

// ============================================================================
// МАПА НОРМАЛІЗАЦІЇ
// ============================================================================

/**
 * Основні нутрієнти (без дефісу)
 */
const MAIN_NUTRIENTS = [
    [/^(калорийность|энергетическая ценность|калорії|енергетична цінність|energy|kcal)$/i, 'Калории'],
    [/^(всего жир(ов|а)?|общ(ее|ий) (содержание )?жир(ов|а)?|total fat|жири|загальний вміст жиру)$/i, 'Жиры'],
    [/^(холестерин(а)?|холестерол|cholesterol)$/i, 'Холестерин'],
    [/^(всего углевод(ов|ы)?|общ(ее|ий) (количество |содержание )?углевод(ов|ы)?|total carb(ohyd)?r?(ate)?s?|вуглеводи|загальна кількість вуглеводів)$/i, 'Углеводы'],
    [/^(белок|белки|белков|білок|білка|білків|protein)$/i, 'Белок'],
    [/^(соль|солі|salt)$/i, 'Соль'],
];

/**
 * Підкатегорії (можуть бути з дефісом або без)
 * Формат: [regex, назва підкатегорії, назва окремого рядка, завжди підкатегорія?]
 * Якщо 4-й параметр true - завжди повертає підкатегорію (напр. "Всего сахаров" → " - сахар")
 */
const SUBCATEGORIES = [
    // Жири
    [/(насыщенн?(ые|ых)( жир(ы|ов)?)?|saturated( fat)?|насичені( жири)?)$/i, 'насыщенные', 'Насыщенные жиры', false],
    [/(транс[- ]?жир(ы|ов)?|trans( fat)?)$/i, 'транс-жиры', 'Транс-жиры', false],
    [/(ненасыщенн?(ые|ых)( жир(ы|ов)?)?|unsaturated|ненасичені)$/i, 'ненасыщенные', 'Ненасыщенные жиры', false],
    [/(мононенасыщенн?(ые|ых)?|monounsaturated)$/i, 'мононенасыщенные', 'Мононенасыщенные жиры', false],
    [/(полиненасыщенн?(ые|ых)?|polyunsaturated)$/i, 'полиненасыщенные', 'Полиненасыщенные жиры', false],
    // Вуглеводи - ВАЖЛИВО: специфічні патерни ПЕРЕД загальними!
    [/(пищев(ые|ых) волокн(а|о)?|пищевых волокон|клетчатк(а|и)|dietary fiber|fibre?|харчові волокна)$/i, 'пищевые волокна', 'Пищевые волокна', true],
    [/(добавленн?(ый|ых|ого) сахар(а|ов)?|added sugars?|includes.*added|доданий цукор)$/i, 'добавленного сахара', 'Добавленный сахар', true],
    [/^(всего сахар(ов|а)?|общ(ее|ий) (содержание )?сахар(ов|а)?|total sugars?|sugars?)$/i, 'сахар', 'Сахар', true],
    [/^(сахар(а|ов)?|цукор|цукру)$/i, 'сахар', 'Сахар', false],
];

// ============================================================================
// ГОЛОВНА ФУНКЦІЯ
// ============================================================================

/**
 * Нормалізує назву нутрієнту
 * @param {string} name - Оригінальна назва
 * @returns {string} - Нормалізована назва
 *
 * @example
 * normalizeNutrientName("Всего углеводов") // → "Углеводы"
 * normalizeNutrientName("- Насыщенные жиры") // → " - насыщенные" (підкатегорія)
 * normalizeNutrientName("Насыщенные жиры") // → "Насыщенные жиры" (окремо)
 */
export function normalizeNutrientName(name) {
    if (!name) return '';

    const cleaned = name.replace(/:$/, '').trim();

    // Перевіряємо основні нутрієнти
    for (const [regex, normalized] of MAIN_NUTRIENTS) {
        if (regex.test(cleaned)) {
            return normalized;
        }
    }

    // Перевіряємо підкатегорії
    const isSubcategory = /^-\s*/.test(cleaned);
    const withoutDash = cleaned.replace(/^-\s*/, '');

    for (const [regex, subName, standaloneName, alwaysSub] of SUBCATEGORIES) {
        if (regex.test(withoutDash)) {
            // alwaysSub = true → завжди підкатегорія (напр. "Всего сахаров")
            return (isSubcategory || alwaysSub) ? ' - ' + subName : standaloneName;
        }
    }

    // Не знайдено - повертаємо як є
    return cleaned;
}

// ============================================================================
// СОРТУВАННЯ НУТРІЄНТІВ
// ============================================================================

/**
 * Стандартний порядок нутрієнтів
 * Підкатегорії (з " - ") автоматично йдуть після батьківського
 */
const NUTRIENT_ORDER = [
    'Калории',
    'Жиры',
    ' - насыщенные',
    ' - транс-жиры',
    ' - ненасыщенные',
    ' - мононенасыщенные',
    ' - полиненасыщенные',
    'Холестерин',
    'Углеводы',
    ' - пищевые волокна',
    ' - сахар',
    ' - добавленного сахара',
    'Белок',
    'Соль',
];

/**
 * Отримати індекс нутрієнта для сортування
 * @param {string} name - Назва нутрієнта
 * @returns {number} - Індекс (999 для невідомих)
 */
function getNutrientIndex(name) {
    const idx = NUTRIENT_ORDER.indexOf(name);
    return idx !== -1 ? idx : 999;
}

/**
 * Сортує масив entries за стандартним порядком нутрієнтів
 * @param {Array<{left: string, right: string}>} entries - Масив записів
 * @returns {Array<{left: string, right: string}>} - Відсортований масив
 *
 * @example
 * sortNutrients([
 *   { left: 'Белок', right: '20 г' },
 *   { left: 'Калории', right: '120' },
 * ])
 * // → [{ left: 'Калории', right: '120' }, { left: 'Белок', right: '20 г' }]
 */
export function sortNutrients(entries) {
    if (!Array.isArray(entries)) return [];

    return [...entries].sort((a, b) => {
        const idxA = getNutrientIndex(a.left);
        const idxB = getNutrientIndex(b.left);
        return idxA - idxB;
    });
}
