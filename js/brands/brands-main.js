// js/brands/brands-main.js

/**
 * â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
 * â•‘                         BRANDS SYSTEM                                    â•‘
 * â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
 * â•‘                                                                          â•‘
 * â•‘  ğŸ”’ Ğ¯Ğ”Ğ Ğ (Ğ½Ğµ Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ‚Ğ¸):                                                  â•‘
 * â•‘  â”œâ”€â”€ brands-main.js     â€” Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ñƒ, Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¿Ğ»Ğ°Ğ³Ñ–Ğ½Ñ–Ğ²             â•‘
 * â•‘  â”œâ”€â”€ brands-plugins.js  â€” Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ñ€ĞµÑ”ÑÑ‚Ñ€Ğ°Ñ†Ñ–Ñ— Ğ¿Ğ»Ğ°Ğ³Ñ–Ğ½Ñ–Ğ² (Ñ…ÑƒĞºĞ¸)             â•‘
 * â•‘  â”œâ”€â”€ brands-state.js    â€” Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½ (brandsState)                  â•‘
 * â•‘  â””â”€â”€ brands-data.js     â€” Google Sheets API (CRUD Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ñ–Ñ—)              â•‘
 * â•‘                                                                          â•‘
 * â•‘  ğŸ”Œ ĞŸĞ›ĞĞ“Ğ†ĞĞ˜ (Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸):                                            â•‘
 * â•‘  â”œâ”€â”€ brands-table.js    â€” Ğ ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ– Ğ±Ñ€ĞµĞ½Ğ´Ñ–Ğ²                      â•‘
 * â•‘  â”œâ”€â”€ brands-crud.js     â€” ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ñ– Ğ²Ñ–ĞºĞ½Ğ° (Ğ´Ğ¾Ğ´Ğ°Ñ‚Ğ¸/Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸/Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸)    â•‘
 * â•‘  â”œâ”€â”€ brands-search.js   â€” ĞŸĞ¾ÑˆÑƒĞº Ñ‚Ğ° Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ñ–Ñ (Ğ² brands-events.js)       â•‘
 * â•‘  â””â”€â”€ brands-ui.js       â€” UI ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¸ (Ñ‡ĞµĞºĞ±Ğ¾ĞºÑĞ¸ ĞºĞ¾Ğ»Ğ¾Ğ½Ğ¾Ğº Ñ– Ñ‚.Ğ´.)        â•‘
 * â•‘                                                                          â•‘
 * â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ Ğ”ĞĞĞ˜Ğ¥ Ğ‘Ğ Ğ•ĞĞ”Ğ£:
 * {
 *   brand_id: "bran-000001",
 *   name_uk: "Optimum Nutrition",
 *   names_alt: ["ON", "Optimum", "ĞĞ¿Ñ‚Ğ¸Ğ¼ÑƒĞ¼"],     // JSON Ğ¼Ğ°ÑĞ¸Ğ²
 *   country_option_id: "Ğ¡Ğ¨Ğ",                    // ĞŸĞ¾ĞºĞ¸ Ñ‚ĞµĞºÑÑ‚, Ğ¿Ğ¾Ñ‚Ñ–Ğ¼ select
 *   brand_status: "active",                      // active | inactive
 *   brand_logo_url: "",                          // Ğ—Ğ°Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ´Ğ¸ÑĞºÑƒ
 *   brand_links: [                               // JSON Ğ¼Ğ°ÑĞ¸Ğ² Ğ¿Ğ¾ÑĞ¸Ğ»Ğ°Ğ½ÑŒ
 *     { name: "ua", url: "https://..." },
 *     { name: "de", url: "https://..." }
 *   ],
 *   brand_text: "<p>HTML Ğ¾Ğ¿Ğ¸Ñ...</p>",
 *   mapper_option_id: ""                         // Ğ—Ğ°Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ´Ğ»Ñ mapper
 * }
 */

import { brandsState } from './brands-state.js';
import { loadBrands } from './brands-data.js';
import { runHook, runHookAsync } from './brands-plugins.js';
import { initPagination } from '../common/ui-pagination.js';
import { initTooltips } from '../common/ui-tooltip.js';
import { renderAvatarState } from '../utils/avatar-states.js';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞŸĞ›ĞĞ“Ğ†ĞĞ˜ - Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ğ±ÑƒĞ´ÑŒ-ÑĞºĞ¸Ğ¹, ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¿Ñ€Ğ°Ñ†ÑĞ²Ğ°Ñ‚Ğ¸Ğ¼Ğµ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PLUGINS = [
    './brands-table.js',
    './brands-crud.js',
    './brands-events.js',
    './brands-ui.js',
];

/**
 * Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ Ğ¿Ğ»Ğ°Ğ³Ñ–Ğ½Ğ¸ Ğ´Ğ¸Ğ½Ğ°Ğ¼Ñ–Ñ‡Ğ½Ğ¾
 */
async function loadPlugins() {
    console.log('[Brands] Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¿Ğ»Ğ°Ğ³Ñ–Ğ½Ñ–Ğ²...');

    const results = await Promise.allSettled(
        PLUGINS.map(path => import(path))
    );

    results.forEach((result, index) => {
        if (result.status === 'fulfilled') {
            console.log(`[Brands] âœ… ĞŸĞ»Ğ°Ğ³Ñ–Ğ½ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ¾: ${PLUGINS[index]}`);
        } else {
            console.warn(`[Brands] âš ï¸ ĞŸĞ»Ğ°Ğ³Ñ–Ğ½ Ğ½Ğµ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ¾: ${PLUGINS[index]}`, result.reason?.message || '');
        }
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ†ĞĞ†Ğ¦Ğ†ĞĞ›Ğ†Ğ—ĞĞ¦Ğ†Ğ¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Ğ“Ğ¾Ğ»Ğ¾Ğ²Ğ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ Ñ–Ğ½Ñ–Ñ†Ñ–Ğ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ— Ğ¼Ğ¾Ğ´ÑƒĞ»Ñ Brands
 */
export async function initBrands() {
    console.log('ğŸ“‹ Ğ†Ğ½Ñ–Ñ†Ñ–Ğ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ Brands...');

    // Ğ†Ğ½Ñ–Ñ†Ñ–Ğ°Ğ»Ñ–Ğ·ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ– UI ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¸
    initTooltips();

    // Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ Ğ¿Ğ»Ğ°Ğ³Ñ–Ğ½Ğ¸
    await loadPlugins();

    // Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ aside
    await loadAsideBrands();

    // Ğ†Ğ½Ñ–Ñ†Ñ–Ğ°Ğ»Ñ–Ğ·ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ¿Ğ°Ğ³Ñ–Ğ½Ğ°Ñ†Ñ–Ñ
    initBrandsPagination();

    // ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ğ¸Ñ‚Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ Ñ‚Ğ° Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ Ğ´Ğ°Ğ½Ñ–
    await checkAuthAndLoadData();

    // Ğ¡Ğ»ÑƒÑ…Ğ°Ñ‚Ğ¸ Ğ¿Ğ¾Ğ´Ñ–Ñ— Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ—
    document.addEventListener('auth-state-changed', async (event) => {
        console.log('ğŸ” ĞŸĞ¾Ğ´Ñ–Ñ auth-state-changed:', event.detail);
        if (event.detail.isAuthorized) {
            await checkAuthAndLoadData();
        }
    });
}

/**
 * ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ğ¸Ñ‚Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ Ñ‚Ğ° Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ Ğ´Ğ°Ğ½Ñ–
 */
async function checkAuthAndLoadData() {
    console.log('ğŸ” ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ—...');

    if (window.isAuthorized) {
        console.log('âœ… ĞšĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹, Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ–...');

        try {
            // Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ Ğ±Ñ€ĞµĞ½Ğ´Ğ¸
            await loadBrands();

            // Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğ¸ Ñ…ÑƒĞº onInit Ğ´Ğ»Ñ Ğ¿Ğ»Ğ°Ğ³Ñ–Ğ½Ñ–Ğ²
            await runHookAsync('onInit', brandsState.brands);

            console.log('âœ… Brands Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ğ¹ Ğ´Ğ¾ Ñ€Ğ¾Ğ±Ğ¾Ñ‚Ğ¸');
        } catch (error) {
            console.error('âŒ ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ…:', error);
            renderErrorState();
        }
    } else {
        console.log('âš ï¸ ĞšĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡ Ğ½Ğµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹');
        renderAuthRequiredState();
    }
}

/**
 * Ğ†Ğ½Ñ–Ñ†Ñ–Ğ°Ğ»Ñ–Ğ·ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ¿Ğ°Ğ³Ñ–Ğ½Ğ°Ñ†Ñ–Ñ
 */
function initBrandsPagination() {
    const footer = document.querySelector('.fixed-footer');
    if (!footer) {
        console.warn('âš ï¸ Footer Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾');
        return;
    }

    const paginationAPI = initPagination(footer, {
        currentPage: brandsState.pagination.currentPage,
        pageSize: brandsState.pagination.pageSize,
        totalItems: brandsState.pagination.totalItems,
        onPageChange: (page, pageSize) => {
            brandsState.pagination.currentPage = page;
            brandsState.pagination.pageSize = pageSize;
            runHook('onRender');
        }
    });

    brandsState.paginationAPI = paginationAPI;

    console.log('âœ… ĞŸĞ°Ğ³Ñ–Ğ½Ğ°Ñ†Ñ–Ñ Ñ–Ğ½Ñ–Ñ†Ñ–Ğ°Ğ»Ñ–Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ°');
}

/**
 * Ğ’Ñ–Ğ´Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ñ‚Ğ¸ ÑÑ‚Ğ°Ğ½ "ĞŸĞ¾Ñ‚Ñ€Ñ–Ğ±Ğ½Ğ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ"
 */
function renderAuthRequiredState() {
    const tableBody = document.querySelector('#tab-brands .pseudo-table-body');
    if (!tableBody) return;

    const avatarHtml = renderAvatarState('authLogin', {
        message: 'ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·ÑƒĞ¹Ñ‚ĞµÑÑŒ Ğ´Ğ»Ñ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ…',
        size: 'medium',
        containerClass: 'empty-state-container',
        avatarClass: 'empty-state-avatar',
        messageClass: 'avatar-state-message',
        showMessage: true
    });

    tableBody.innerHTML = avatarHtml;
}

/**
 * Ğ’Ñ–Ğ´Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ñ‚Ğ¸ ÑÑ‚Ğ°Ğ½ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ¸
 */
function renderErrorState() {
    const tableBody = document.querySelector('#tab-brands .pseudo-table-body');
    if (!tableBody) return;

    const avatarHtml = renderAvatarState('error', {
        message: 'ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ…',
        size: 'medium',
        containerClass: 'empty-state-container',
        avatarClass: 'empty-state-avatar',
        messageClass: 'avatar-state-message',
        showMessage: true
    });

    tableBody.innerHTML = avatarHtml;
}

/**
 * Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ aside Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ
 */
async function loadAsideBrands() {
    const panelRightContent = document.getElementById('panel-right-content');
    if (!panelRightContent) return;

    try {
        const response = await fetch('templates/aside/aside-brands.html');
        if (!response.ok) throw new Error('Failed to load aside-brands.html');

        const html = await response.text();
        panelRightContent.innerHTML = html;

        console.log('âœ… aside-brands.html Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ¾');
    } catch (error) {
        console.error('âŒ ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ aside-brands.html:', error);
    }
}
