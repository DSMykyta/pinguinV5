// js/mapper/mapper-marketplaces.js

/**
 * ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
 * ‚ïë                    MAPPER - MARKETPLACES PLUGIN                          ‚ïë
 * ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
 * ‚ïë  üîå –ü–õ–ê–ì–Ü–ù ‚Äî –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∏: CRUD –æ–ø–µ—Ä–∞—Ü—ñ—ó + –º–æ–¥–∞–ª–∫–∏ + –ø–µ—Ä–µ–≥–ª—è–¥ –¥–∞–Ω–∏—Ö      ‚ïë
 * ‚ïë                                                                          ‚ïë
 * ‚ïë  –ü–†–ò–ó–ù–ê–ß–ï–ù–ù–Ø:                                                            ‚ïë
 * ‚ïë  –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞–º–∏ —Ç–∞ –ø–µ—Ä–µ–≥–ª—è–¥ —ó—Ö –¥–∞–Ω–∏—Ö (–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó, —Ö–∞—Ä–∞–∫-–∫–∏).   ‚ïë
 * ‚ïë                                                                          ‚ïë
 * ‚ïë  –ï–ö–°–ü–û–†–¢–û–í–ê–ù–Ü –§–£–ù–ö–¶–Ü–á:                                                   ‚ïë
 * ‚ïë  - init() ‚Äî –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–ª–∞–≥—ñ–Ω–∞ (—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è hooks)                     ‚ïë
 * ‚ïë  - showAddMarketplaceModal() ‚Äî –ú–æ–¥–∞–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è                         ‚ïë
 * ‚ïë  - showEditMarketplaceModal(id) ‚Äî –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è                    ‚ïë
 * ‚ïë  - showMarketplaceDataModal(id) ‚Äî –ü–µ—Ä–µ–≥–ª—è–¥ –¥–∞–Ω–∏—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—É            ‚ïë
 * ‚ïë                                                                          ‚ïë
 * ‚ïë  –ó–ê–õ–ï–ñ–ù–û–°–¢–Ü:                                                             ‚ïë
 * ‚ïë  - mapper-state.js (state, hooks)                                        ‚ïë
 * ‚ïë  - mapper-data.js (API –æ–ø–µ—Ä–∞—Ü—ñ—ó)                                         ‚ïë
 * ‚ïë  - mapper-table.js (—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥)                                           ‚ïë
 * ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
 */

import { mapperState, registerHook, markPluginLoaded, runHook } from './mapper-state.js';
import {
    addMarketplace, updateMarketplace, deleteMarketplace, getMarketplaces,
    getCategories, getCharacteristics, getOptions,
    getMpCategories, getMpCharacteristics, getMpOptions,
    loadMpCategories, loadMpCharacteristics, loadMpOptions
} from './mapper-data.js';
import { renderCurrentTab } from './mapper-table.js';
import { showModal, closeModal } from '../common/ui-modal.js';
import { showToast } from '../common/ui-toast.js';
import { showConfirmModal } from '../common/ui-modal-confirm.js';
import { escapeHtml } from '../utils/text-utils.js';

export const PLUGIN_NAME = 'mapper-marketplaces';

/**
 * –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–ª–∞–≥—ñ–Ω–∞
 * –†–µ—î—Å—Ç—Ä—É—î hooks —Ç–∞ –ø–æ–∑–Ω–∞—á–∞—î –ø–ª–∞–≥—ñ–Ω —è–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π
 */
export function init() {
    // –†–µ—î—Å—Ç—Ä—É—î–º–æ hooks –¥–ª—è –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó –∑ —ñ–Ω—à–∏–º–∏ –º–æ–¥—É–ª—è–º–∏
    registerHook('onTabChange', handleTabChange);
    registerHook('onDataLoaded', handleDataLoaded);

    markPluginLoaded(PLUGIN_NAME);
}

/**
 * –û–±—Ä–æ–±–Ω–∏–∫ –∑–º—ñ–Ω–∏ —Ç–∞–±—É
 */
function handleTabChange(newTab, prevTab) {
    if (newTab === 'marketplaces') {
        // –¢–∞–± –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ñ–≤ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ
    }
}

/**
 * –û–±—Ä–æ–±–Ω–∏–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
 */
function handleDataLoaded() {
    // –û–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω—ñ –¥–∞–Ω—ñ —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CRUD –ú–û–î–ê–õ–ö–ò
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—É
 */
export async function showAddMarketplaceModal() {

    await showModal('mapper-marketplace-edit', null);
    await new Promise(resolve => requestAnimationFrame(resolve));

    const title = document.getElementById('modal-title');
    if (title) title.textContent = '–î–æ–¥–∞—Ç–∏ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å';

    const deleteBtn = document.getElementById('delete-mapper-marketplace');
    if (deleteBtn) deleteBtn.classList.add('u-hidden');

    clearMarketplaceForm();

    const saveBtn = document.getElementById('save-mapper-marketplace');
    if (saveBtn) {
        saveBtn.onclick = handleSaveNewMarketplace;
    }
}

/**
 * –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—É
 */
export async function showEditMarketplaceModal(id) {

    const marketplaces = getMarketplaces();
    const marketplace = marketplaces.find(m => m.id === id);

    if (!marketplace) {
        showToast('–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
        return;
    }

    await showModal('mapper-marketplace-edit', null);

    const title = document.getElementById('modal-title');
    if (title) title.textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å';

    const deleteBtn = document.getElementById('delete-mapper-marketplace');
    if (deleteBtn) {
        deleteBtn.classList.remove('u-hidden');
        deleteBtn.onclick = () => {
            closeModal();
            showDeleteMarketplaceConfirm(id);
        };
    }

    fillMarketplaceForm(marketplace);

    const saveBtn = document.getElementById('save-mapper-marketplace');
    if (saveBtn) {
        saveBtn.onclick = () => handleUpdateMarketplace(id);
    }
}

async function showDeleteMarketplaceConfirm(id) {
    const marketplaces = getMarketplaces();
    const marketplace = marketplaces.find(m => m.id === id);

    if (!marketplace) {
        showToast('–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
        return;
    }

    const confirmed = await showConfirmModal({
        title: '–í–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å?',
        message: `–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å "${marketplace.name}"?`,
        confirmText: '–í–∏–¥–∞–ª–∏—Ç–∏',
        cancelText: '–°–∫–∞—Å—É–≤–∞—Ç–∏',
        confirmClass: 'btn-danger'
    });

    if (confirmed) {
        try {
            await deleteMarketplace(id);
            showToast('–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –≤–∏–¥–∞–ª–µ–Ω–æ', 'success');
            renderCurrentTab();
        } catch (error) {
            showToast('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—É', 'error');
        }
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –§–û–†–ú–ê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function handleSaveNewMarketplace() {
    const data = getMarketplaceFormData();

    if (!data.name) {
        showToast('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—É', 'error');
        return;
    }

    if (!data.slug) {
        showToast('–í–≤–µ–¥—ñ—Ç—å slug –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—É', 'error');
        return;
    }

    try {
        await addMarketplace(data);
        showToast('–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –¥–æ–¥–∞–Ω–æ', 'success');
        closeModal();
        renderCurrentTab();
    } catch (error) {
        showToast('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—É', 'error');
    }
}

async function handleUpdateMarketplace(id) {
    const data = getMarketplaceFormData();

    if (!data.name) {
        showToast('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—É', 'error');
        return;
    }

    try {
        await updateMarketplace(id, data);
        showToast('–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –æ–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        closeModal();
        renderCurrentTab();
    } catch (error) {
        showToast('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—É', 'error');
    }
}

function getMarketplaceFormData() {
    const activeYes = document.getElementById('mapper-mp-active-yes');
    const isActive = activeYes?.checked ?? true;

    return {
        name: document.getElementById('mapper-mp-name')?.value.trim() || '',
        slug: document.getElementById('mapper-mp-slug')?.value.trim() || '',
        is_active: isActive
    };
}

function fillMarketplaceForm(marketplace) {
    const nameField = document.getElementById('mapper-mp-name');
    const slugField = document.getElementById('mapper-mp-slug');
    const activeYes = document.getElementById('mapper-mp-active-yes');
    const activeNo = document.getElementById('mapper-mp-active-no');

    if (nameField) nameField.value = marketplace.name || '';
    if (slugField) slugField.value = marketplace.slug || '';

    const isActive = marketplace.is_active === true || String(marketplace.is_active).toLowerCase() === 'true';
    if (activeYes) activeYes.checked = isActive;
    if (activeNo) activeNo.checked = !isActive;
}

function clearMarketplaceForm() {
    const nameField = document.getElementById('mapper-mp-name');
    const slugField = document.getElementById('mapper-mp-slug');
    const activeYes = document.getElementById('mapper-mp-active-yes');
    const activeNo = document.getElementById('mapper-mp-active-no');

    if (nameField) nameField.value = '';
    if (slugField) slugField.value = '';
    if (activeYes) activeYes.checked = true;
    if (activeNo) activeNo.checked = false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ü–ï–†–ï–ì–õ–Ø–î –î–ê–ù–ò–• –ú–ê–†–ö–ï–¢–ü–õ–ï–ô–°–£
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const mpDataModalState = {
    marketplaceId: null,
    marketplaceName: '',
    activeTab: 'categories',
    filter: 'all',
    searchQuery: '',
    categories: [],
    characteristics: [],
    options: []
};

const MP_DATA_PAGE_SIZE = 100;

/**
 * –ü–æ–∫–∞–∑–∞—Ç–∏ –¥–∞–Ω—ñ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—É
 */
export async function showMarketplaceDataModal(id) {

    const marketplaces = getMarketplaces();
    const marketplace = marketplaces.find(m => m.id === id);

    if (!marketplace) {
        showToast('–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
        return;
    }

    mpDataModalState.marketplaceId = id;
    mpDataModalState.marketplaceName = marketplace.name;
    mpDataModalState.activeTab = 'categories';
    mpDataModalState.filter = 'all';
    mpDataModalState.searchQuery = '';

    await showModal('mapper-mp-data', null);
    await new Promise(resolve => requestAnimationFrame(resolve));

    const title = document.getElementById('mp-data-modal-title');
    if (title) title.textContent = `${marketplace.name} - –î–∞–Ω—ñ`;

    await loadMpDataForModal(id);
    initMpDataModalEvents();
    renderMpDataModalTable();
}

async function loadMpDataForModal(marketplaceId) {
    const allCats = getMpCategories();
    const allChars = getMpCharacteristics();
    const allOpts = getMpOptions();

    if (allCats.length === 0) await loadMpCategories();
    if (allChars.length === 0) await loadMpCharacteristics();
    if (allOpts.length === 0) await loadMpOptions();

    mpDataModalState.categories = getMpCategories().filter(c => c.marketplace_id === marketplaceId);
    mpDataModalState.characteristics = getMpCharacteristics().filter(c => c.marketplace_id === marketplaceId);
    mpDataModalState.options = getMpOptions().filter(o => o.marketplace_id === marketplaceId);

    const catCount = document.getElementById('mp-data-cat-count');
    const charCount = document.getElementById('mp-data-char-count');
    const optCount = document.getElementById('mp-data-opt-count');

    if (catCount) catCount.textContent = mpDataModalState.categories.length;
    if (charCount) charCount.textContent = mpDataModalState.characteristics.length;
    if (optCount) optCount.textContent = mpDataModalState.options.length;

}

function initMpDataModalEvents() {
    const tabButtons = document.querySelectorAll('#mp-data-tabs [data-mp-tab]');
    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            mpDataModalState.activeTab = btn.dataset.mpTab;
            renderMpDataModalTable();
        });
    });

    const filterButtons = document.querySelectorAll('#mp-data-filter-pills [data-mp-filter]');
    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            filterButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            mpDataModalState.filter = btn.dataset.mpFilter;
            renderMpDataModalTable();
        });
    });

    const searchInput = document.getElementById('mp-data-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            mpDataModalState.searchQuery = e.target.value.toLowerCase();
            renderMpDataModalTable();
        });
    }
}

function renderMpDataModalTable() {
    const container = document.getElementById('mp-data-table-container');
    if (!container) return;

    const { activeTab, filter, searchQuery } = mpDataModalState;

    let data = [];
    let columns = [];

    if (activeTab === 'categories') {
        data = [...mpDataModalState.categories];
        columns = getMpCategoriesColumns();
    } else if (activeTab === 'characteristics') {
        data = [...mpDataModalState.characteristics];
        columns = getMpCharacteristicsColumns();
    } else if (activeTab === 'options') {
        data = [...mpDataModalState.options];
        columns = getMpOptionsColumns();
    }

    if (filter === 'mapped') {
        data = data.filter(item => {
            if (activeTab === 'categories') return !!item.our_category_id;
            if (activeTab === 'characteristics') return !!item.our_char_id;
            if (activeTab === 'options') return !!item.our_option_id;
            return true;
        });
    } else if (filter === 'unmapped') {
        data = data.filter(item => {
            if (activeTab === 'categories') return !item.our_category_id;
            if (activeTab === 'characteristics') return !item.our_char_id;
            if (activeTab === 'options') return !item.our_option_id;
            return true;
        });
    }

    if (searchQuery) {
        data = data.filter(item => {
            const name = (item.name || '').toLowerCase();
            const extId = (item.external_id || '').toLowerCase();
            return name.includes(searchQuery) || extId.includes(searchQuery);
        });
    }

    const filteredCount = data.length;
    const statsEl = document.getElementById('mp-data-stats-text');
    const totalCount = activeTab === 'categories' ? mpDataModalState.categories.length :
        activeTab === 'characteristics' ? mpDataModalState.characteristics.length :
            mpDataModalState.options.length;

    if (data.length === 0) {
        container.innerHTML = `
            <div class="empty-state-container">
                <div class="avatar-state-message">–î–∞–Ω—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ</div>
            </div>
        `;
        if (statsEl) statsEl.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ 0 –∑ ${totalCount}`;
        return;
    }

    const displayData = data.slice(0, MP_DATA_PAGE_SIZE);
    const hasMore = data.length > MP_DATA_PAGE_SIZE;

    if (statsEl) {
        if (hasMore) {
            statsEl.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ ${displayData.length} –∑ ${filteredCount} (–≤—Å—å–æ–≥–æ ${totalCount})`;
        } else {
            statsEl.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ ${filteredCount} –∑ ${totalCount}`;
        }
    }

    try {
        const headerHtml = columns.map(col => `<div class="cell ${col.className || ''}">${col.label}</div>`).join('');
        const rowsHtml = displayData.map(item => {
            const cellsHtml = columns.map(col => {
                const value = item[col.id];
                const rendered = col.render ? col.render(value, item) : escapeHtml(value || '-');
                return `<div class="cell ${col.className || ''}">${rendered}</div>`;
            }).join('');
            return `<div class="pseudo-table-row" data-id="${escapeHtml(item.id || '')}">${cellsHtml}</div>`;
        }).join('');

        let tableHtml = `
            <div class="pseudo-table">
                <div class="pseudo-table-header">${headerHtml}</div>
                <div class="pseudo-table-body">${rowsHtml}</div>
            </div>
        `;

        if (hasMore) {
            tableHtml += `
                <div class="mp-data-more-hint" style="text-align: center; padding: 1rem; color: var(--color-text-tertiary);">
                    –ü–æ–∫–∞–∑–∞–Ω–æ –ø–µ—Ä—à—ñ ${MP_DATA_PAGE_SIZE} –∑–∞–ø–∏—Å—ñ–≤. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –ø–æ—à—É–∫ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó.
                </div>
            `;
        }

        container.innerHTML = tableHtml;
    } catch (error) {
        console.error('‚ùå Error rendering table:', error);
        container.innerHTML = `
            <div class="empty-state-container">
                <div class="avatar-state-message">–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è: ${error.message}</div>
            </div>
        `;
    }
}

function getMpCategoriesColumns() {
    const categories = getCategories();
    return [
        { id: 'external_id', label: 'ID', className: 'cell-m' },
        { id: 'name', label: '–ù–∞–∑–≤–∞', className: 'cell-xl', render: (v) => `<strong>${escapeHtml(v || '')}</strong>` },
        { id: 'parent_name', label: '–ë–∞—Ç—å–∫—ñ–≤—Å—å–∫–∞' },
        {
            id: 'our_category_id',
            label: '–ù–∞—à–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è',
            render: (v) => {
                if (!v) return '<span class="severity-badge severity-high">–ù–µ –ø—Ä–∏–≤\'—è–∑–∞–Ω–æ</span>';
                const cat = categories.find(c => c.id === v);
                return `<span class="severity-badge severity-low">${escapeHtml(cat?.name_ua || v)}</span>`;
            }
        }
    ];
}

function getMpCharacteristicsColumns() {
    const characteristics = getCharacteristics();
    return [
        { id: 'external_id', label: 'ID', className: 'cell-m' },
        { id: 'name', label: '–ù–∞–∑–≤–∞', className: 'cell-xl', render: (v) => `<strong>${escapeHtml(v || '')}</strong>` },
        { id: 'type', label: '–¢–∏–ø', render: (v) => `<code>${escapeHtml(v || '-')}</code>` },
        {
            id: 'our_char_id',
            label: '–ù–∞—à–∞ —Ö–∞—Ä–∞–∫—Ç.',
            render: (v) => {
                if (!v) return '<span class="severity-badge severity-high">–ù–µ –ø—Ä–∏–≤\'—è–∑–∞–Ω–æ</span>';
                const char = characteristics.find(c => c.id === v);
                return `<span class="severity-badge severity-low">${escapeHtml(char?.name_ua || v)}</span>`;
            }
        }
    ];
}

function getMpOptionsColumns() {
    const options = getOptions();
    return [
        { id: 'external_id', label: 'ID', className: 'cell-m' },
        { id: 'name', label: '–ù–∞–∑–≤–∞', className: 'cell-xl', render: (v) => `<strong>${escapeHtml(v || '')}</strong>` },
        { id: 'char_id', label: '–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞' },
        {
            id: 'our_option_id',
            label: '–ù–∞—à–∞ –æ–ø—Ü—ñ—è',
            render: (v) => {
                if (!v) return '<span class="severity-badge severity-high">–ù–µ –ø—Ä–∏–≤\'—è–∑–∞–Ω–æ</span>';
                const opt = options.find(o => o.id === v);
                return `<span class="severity-badge severity-low">${escapeHtml(opt?.value_ua || v)}</span>`;
            }
        }
    ];
}
